<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pidey Store — Test Runner</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2>Automated Test Runner — Pidey Store</h2>
    <div id="results"></div>
  </div>

  <script src="data.js"></script>
  <script src="script.js"></script>
  <script>
    (async function(){
      // Avoid UI blocking dialogs in headless test
      window.alert = ()=>{};
      window.confirm = ()=>true;

      const out = document.getElementById('results');
      function log(ok, msg){
        const el = document.createElement('div');
        el.textContent = (ok? '✅ ':'❌ ') + msg;
        el.style.marginBottom = '.4rem';
        out.appendChild(el);
      }

      try{
        // Test 1: reset defaults
        if(typeof resetDefaults === 'function'){
          resetDefaults();
          log(true, 'resetDefaults() executed');
        }

        const games = loadGames();
        if(Array.isArray(games) && games.length >= 3) log(true, 'loadGames returned array with >=3 items'); else log(false, 'loadGames failed or returned insufficient items');

        const ml = games.find(g=>g.id==='mlbb');
        if(ml && Array.isArray(ml.products) && ml.products.length >= 3) log(true, 'mlbb has product list'); else log(false, 'mlbb product list missing');

        // Test 2: Order flow (simulate one product order)
        const before = ml.products[0].stock;
        if(before > 0){
          const all = loadGames();
          const g = all.find(x=>x.id==='mlbb');
          g.products[0].stock = Math.max(0, g.products[0].stock -1);
          saveGames(all);
          const after = loadGames().find(x=>x.id==='mlbb').products[0].stock;
          if(after === before - 1) log(true, 'Order simulation decremented product stock'); else log(false, 'Order decrement failed');
        } else {
          log(false, 'No stock to simulate order');
        }

        // Test 3: Admin add game
        const makeInput = (id, val)=>{ let el = document.getElementById(id); if(!el){ el = document.createElement('input'); el.id = id; document.body.appendChild(el);} el.value = val; };
        makeInput('new_name','Test Game'); makeInput('new_id','testgame'); makeInput('new_server','EU');
        let desc = document.getElementById('new_desc'); if(!desc){ desc = document.createElement('textarea'); desc.id='new_desc'; document.body.appendChild(desc);} desc.value = 'Test game desc';
        if(typeof addNewGameFromForm === 'function'){
          addNewGameFromForm();
          const added = loadGames().find(x=>x.id==='testgame');
          if(added && added.name==='Test Game') log(true, 'addNewGameFromForm added game'); else log(false, 'addNewGameFromForm failed');
        } else {
          log(false, 'addNewGameFromForm not found');
        }

        // Test 4: Import/Export
        const allBefore = loadGames();
        const blown = JSON.parse(JSON.stringify(allBefore));
        if(blown.length>0){ blown[0].name = 'MODIFIED_NAME_TEST'; }
        if(typeof importGamesFile === 'function'){
          const f = new File([JSON.stringify(blown)], 'import.json', {type:'application/json'});
          await new Promise((res)=>{ importGamesFile(f); setTimeout(res, 400); });
          const afterImport = loadGames();
          if(afterImport[0] && afterImport[0].name === 'MODIFIED_NAME_TEST') log(true, 'importGamesFile replaced games'); else log(false, 'importGamesFile did not replace games');
          saveGames(allBefore);
        } else {
          log(false, 'importGamesFile not available');
        }

        // Test 5: Reset returns to default
        if(typeof resetDefaults === 'function'){
          resetDefaults();
          const afterReset = loadGames();
          if(afterReset.find(x=>x.id==='mlbb')) log(true, 'resetDefaults restored defaults'); else log(false, 'resetDefaults did not restore');
        }

        log(true, 'All scripted checks finished');
      }catch(err){
        log(false, 'Test runner error: ' + err.message);
      }
    })();
  </script>
</body>
</html>